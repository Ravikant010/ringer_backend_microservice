name: Deploy Microservices to AWS EC2 (SSH)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_DIR: /home/ec2-user/microservices-app

jobs:
  deploy:
    name: Deploy to EC2 via SSH
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH for EC2
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy Application with SSH Authentication
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ“ Setting up deployment directory..."
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Set up SSH key for GitHub access on EC2
          mkdir -p ~/.ssh
          echo "${{ secrets.REPO_SSH_KEY }}" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key
          
          # Add GitHub to known hosts
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Create SSH config for GitHub
          cat > ~/.ssh/config << 'SSH_CONFIG'
        Host github.com
          HostName github.com
          User git
          IdentityFile ~/.ssh/github_deploy_key
          StrictHostKeyChecking no
        SSH_CONFIG
          chmod 600 ~/.ssh/config
          
          # Test SSH connection to GitHub
          echo "ğŸ”— Testing GitHub SSH connection..."
          ssh -T git@github.com || true
          
          # Clone or update repository
          if [ ! -d ".git" ]; then
            echo "ğŸ†• First deployment - cloning repository via SSH..."
            rm -rf * .[^.]* 2>/dev/null || true
            git clone git@github.com:${{ github.repository }}.git .
          else
            echo "ğŸ”„ Updating existing repository via SSH..."
            # Update remote URL to use SSH
            git remote set-url origin git@github.com:${{ github.repository }}.git
            
            # Stash any local changes
            git stash push -m "Auto-stash before deployment" 2>/dev/null || true
            
            # Fetch and reset
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            git pull origin main
          fi
          
          # Verify we're in correct directory and files exist
          echo "ğŸ“‹ Current directory: $(pwd)"
          echo "ğŸ“‚ Directory contents:"
          ls -la
          
          # Verify docker-compose.yml exists
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ CRITICAL ERROR: docker-compose.yml not found!"
            echo "Available files:"
            find . -name "*.yml" -o -name "*.yaml" -o -name "docker-compose*" 2>/dev/null
            exit 1
          fi
          
          echo "âœ… Found docker-compose.yml"
          
          echo "ğŸ›‘ Stopping existing services..."
          sudo docker-compose down || true
          
          echo "ğŸ§¹ Cleaning Docker resources..."
          sudo docker system prune -f || true
          
          echo "ğŸ”¨ Building and starting services..."
          sudo docker-compose up --build -d
          
          echo "â° Waiting for services to initialize..."
          sleep 45
          
          echo "ğŸ“Š Container status:"
          sudo docker-compose ps
          
        EOF

    - name: Health Check All Services (Fixed)
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          # CRITICAL FIX: Ensure we're in the correct directory
          echo "ğŸ” Navigating to deployment directory..."
          cd ${{ env.APP_DIR }} || { echo "âŒ Cannot access deployment directory"; exit 1; }
          
          # Verify we're in the right place
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‹ Checking for docker-compose.yml..."
          
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ CRITICAL: docker-compose.yml not found in $(pwd)"
            echo "Directory contents:"
            ls -la
            exit 1
          fi
          
          echo "âœ… docker-compose.yml found in $(pwd)"
          
          echo "=== Comprehensive Health Check ==="
          
          # Check overall container status first
          echo "ğŸ“Š Overall container status:"
          sudo docker-compose ps || { echo "âŒ docker-compose ps failed"; exit 1; }
          
          # Define all services with their ports
          declare -A services=(
            ["user-service"]=3001
            ["post-service"]=3002
            ["comment-service"]=3003
            ["chat-service"]=3004
            ["media-service"]=3005
            ["notification-service"]=3006
            ["analytics-service"]=3007
            ["search-service"]=3008
          )
          
          healthy_count=0
          total_count=${#services[@]}
          
          echo "ğŸ¥ Testing $total_count services..."
          
          for service in "${!services[@]}"; do
            port=${services[$service]}
            
            # Check if container is running
            if sudo docker-compose ps $service | grep -q "Up"; then
              echo "ğŸŸ¢ $service container is running"
              
              # Health endpoint check with retries
              for attempt in {1..3}; do
                if curl -f -s --max-time 5 http://localhost:$port/health > /dev/null 2>&1; then
                  echo "âœ… $service is healthy (port $port)"
                  healthy_count=$((healthy_count + 1))
                  break
                elif [ $attempt -eq 3 ]; then
                  echo "âš ï¸  $service container running but health check failed (port $port)"
                  # Show container logs for failed service
                  echo "ğŸ” Last 10 lines of $service logs:"
                  sudo docker-compose logs --tail=10 $service
                else
                  echo "â³ $service not ready, retrying... ($attempt/3)"
                  sleep 10
                fi
              done
            else
              echo "âŒ $service container is not running"
              # Show why container failed
              echo "ğŸ” Container status for $service:"
              sudo docker-compose ps $service
              echo "ğŸ” Last 10 lines of $service logs:"
              sudo docker-compose logs --tail=10 $service
            fi
          done
          
          echo "=========================="
          echo "ğŸ¥ Health Summary: $healthy_count/$total_count services healthy"
          
          if [ $healthy_count -eq $total_count ]; then
            echo "ğŸ‰ All services are healthy! Deployment successful!"
          elif [ $healthy_count -gt 0 ]; then
            echo "âš ï¸  Partial deployment success ($healthy_count/$total_count services healthy)"
            echo "ğŸ” Check logs above for failed services"
          else
            echo "âŒ Deployment failed - no services are healthy"
            echo "ğŸ” Full container status:"
            sudo docker-compose ps
            echo "ğŸ” All container logs:"
            sudo docker-compose logs --tail=20
            exit 1
          fi
          
        EOF

    - name: Display Service URLs
      if: success()
      run: |
        echo "ğŸŒ Your microservices are now live at:"
        echo ""
        echo "   ğŸš€ User Service:         http://${{ secrets.EC2_HOST }}:3001/health"
        echo "   ğŸ“ Post Service:         http://${{ secrets.EC2_HOST }}:3002/health"
        echo "   ğŸ’¬ Comment Service:      http://${{ secrets.EC2_HOST }}:3003/health"
        echo "   ğŸ’¬ Chat Service:         http://${{ secrets.EC2_HOST }}:3004/health"
        echo "   ğŸ“ Media Service:        http://${{ secrets.EC2_HOST }}:3005/health"
        echo "   ğŸ”” Notification Service: http://${{ secrets.EC2_HOST }}:3006/health"
        echo "   ğŸ“Š Analytics Service:    http://${{ secrets.EC2_HOST }}:3007/health"
        echo "   ğŸ” Search Service:       http://${{ secrets.EC2_HOST }}:3008/health"

    - name: Cleanup SSH Keys
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key

    - name: Deployment Failure Help
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo ""
        echo "ğŸ”§ Manual troubleshooting on EC2:"
        echo "1. SSH: ssh -i your-key.pem ec2-user@${{ secrets.EC2_HOST }}"
        echo "2. Check directory: cd ${{ env.APP_DIR }} && ls -la"
        echo "3. Check containers: sudo docker-compose ps"
        echo "4. Check logs: sudo docker-compose logs [service-name]"
        echo "5. Restart services: sudo docker-compose down && sudo docker-compose up -d"
