name: Deploy Microservices to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggers

env:
  APP_DIR: /home/ec2-user/microservices-app

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH Connection
      run: |
        ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"

    - name: Prepare EC2 Environment
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          # Create app directory if it doesn't exist
          mkdir -p ${{ env.APP_DIR }}
          
          # Stop existing services if running
          cd ${{ env.APP_DIR }} 2>/dev/null || true
          if [ -f docker-compose.yml ]; then
            echo "Stopping existing services..."
            sudo docker-compose down || true
          fi
        EOF

    - name: Deploy Application
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e  # Exit on any error
          
          echo "üìÅ Setting up deployment directory..."
          cd ${{ env.APP_DIR }}
          
          # Clean deployment (remove existing files)
          echo "üßπ Cleaning previous deployment..."
          rm -rf * .git .gitignore 2>/dev/null || true
          
          echo "üì• Cloning repository..."
          git clone https://github.com/${{ github.repository }}.git .
          
          # Verify docker-compose.yml exists
          if [ ! -f docker-compose.yml ]; then
            echo "‚ùå ERROR: docker-compose.yml not found in repository root!"
            echo "Available files:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ Found docker-compose.yml file"
          
          echo "üõë Stopping any existing containers..."
          sudo docker-compose down || true
          
          echo "üßπ Cleaning up Docker resources..."
          sudo docker system prune -f || true
          
          echo "üî® Building and starting services..."
          sudo docker-compose up --build -d
          
          echo "‚è∞ Waiting for services to start..."
          sleep 30
          
          echo "üìä Container status:"
          sudo docker-compose ps
          
        EOF

    - name: Health Check Services
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ env.APP_DIR }}
          
          echo "=== Health Check Results ==="
          
          # Define services and ports
          declare -A services=(
            ["user-service"]=3001
            ["post-service"]=3002
            ["comment-service"]=3003
            ["chat-service"]=3004
            ["media-service"]=3005
            ["notification-service"]=3006
            ["analytics-service"]=3007
            ["search-service"]=3008
          )
          
          healthy_count=0
          total_count=${#services[@]}
          
          for service in "${!services[@]}"; do
            port=${services[$service]}
            
            # Check if container is running
            if sudo docker-compose ps $service | grep -q "Up"; then
              # Check health endpoint
              if curl -f -s --max-time 5 http://localhost:$port/health > /dev/null; then
                echo "‚úÖ $service is healthy (port $port)"
                healthy_count=$((healthy_count + 1))
              else
                echo "‚ö†Ô∏è  $service container running but health check failed (port $port)"
              fi
            else
              echo "‚ùå $service container is not running"
            fi
          done
          
          echo "=== Summary ==="
          echo "Healthy services: $healthy_count/$total_count"
          
          if [ $healthy_count -eq $total_count ]; then
            echo "üéâ All services deployed successfully!"
          else
            echo "‚ö†Ô∏è  Some services may have issues. Check logs with:"
            echo "   sudo docker-compose logs [service-name]"
          fi
          
        EOF

    - name: Show Service URLs
      if: success()
      run: |
        echo "üåê Your services are now available at:"
        echo "   ‚Ä¢ User Service: http://${{ secrets.EC2_HOST }}:3001"
        echo "   ‚Ä¢ Post Service: http://${{ secrets.EC2_HOST }}:3002"
        echo "   ‚Ä¢ Comment Service: http://${{ secrets.EC2_HOST }}:3003"
        echo "   ‚Ä¢ Chat Service: http://${{ secrets.EC2_HOST }}:3004"
        echo "   ‚Ä¢ Media Service: http://${{ secrets.EC2_HOST }}:3005"
        echo "   ‚Ä¢ Notification Service: http://${{ secrets.EC2_HOST }}:3006"
        echo "   ‚Ä¢ Analytics Service: http://${{ secrets.EC2_HOST }}:3007"
        echo "   ‚Ä¢ Search Service: http://${{ secrets.EC2_HOST }}:3008"

    - name: Cleanup SSH Key
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key

    - name: Failure Notification
      if: failure()
      run: |
        echo "‚ùå Deployment failed! Check the logs above for details."
        echo "üîç Common fixes:"
        echo "   1. Ensure docker-compose.yml exists in repository root"
        echo "   2. Check GitHub secrets are set correctly"
        echo "   3. Verify EC2 instance has Docker and Git installed"
        echo "   4. Confirm security group allows required ports"
