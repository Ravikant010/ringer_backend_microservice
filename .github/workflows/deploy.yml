name: Build and Deploy Microservices to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_DIR: /home/ec2-user/microservices-app
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    # ===== BUILD PHASE (Runs on GitHub) =====
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'  # Automatically caches npm dependencies

    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install Dependencies (All Services)
      run: |
        # Install dependencies for each microservice
        services=("user-service" "post-service" "comment-service" "chat-service" "media-service" "notification-service" "analytics-service" "search-service")
        
        for service in "${services[@]}"; do
          if [ -f "./services/$service/package.json" ]; then
            echo "ğŸ“¦ Installing dependencies for $service..."
            cd "./services/$service"
            npm ci --only=production
            cd "../.."
          fi
        done

    - name: Build All Services
      run: |
        # Build each microservice if build script exists
        services=("user-service" "post-service" "comment-service" "chat-service" "media-service" "notification-service" "analytics-service" "search-service")
        
        for service in "${services[@]}"; do
          if [ -f "./services/$service/package.json" ]; then
            cd "./services/$service"
            if npm run build 2>/dev/null; then
              echo "âœ… Built $service successfully"
            else
              echo "â„¹ï¸  No build script for $service (skipping)"
            fi
            cd "../.."
          fi
        done

    # ===== DEPLOY PHASE (Deploy to EC2) =====
    - name: Set up SSH for EC2
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2 with Complete Setup
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "ğŸš€ Starting automated deployment..."
          
          # Create deployment directory
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Setup SSH for GitHub (so git clone works)
          mkdir -p ~/.ssh
          echo "${{ secrets.REPO_SSH_KEY }}" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key
          
          cat > ~/.ssh/config << 'SSH_CONFIG'
        Host github.com
          HostName github.com
          User git
          IdentityFile ~/.ssh/github_deploy_key
          StrictHostKeyChecking no
        SSH_CONFIG
          chmod 600 ~/.ssh/config
          
          # Test SSH connection
          ssh -T git@github.com || true
          
          # Clone/Update repository
          if [ ! -d ".git" ]; then
            echo "ğŸ†• First deployment - cloning repository..."
            rm -rf * .[^.]* 2>/dev/null || true
            git clone git@github.com:${{ github.repository }}.git .
          else
            echo "ğŸ”„ Updating existing repository..."
            git remote set-url origin git@github.com:${{ github.repository }}.git
            git stash push -m "Auto-stash" 2>/dev/null || true
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            git pull origin main
          fi
          
          # Verify critical files
          echo "ğŸ“‹ Verifying deployment files..."
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ CRITICAL: docker-compose.yml not found!"
            ls -la
            exit 1
          fi
          echo "âœ… docker-compose.yml found"
          
          # Install Node.js if not present (for EC2)
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ Installing Node.js on EC2..."
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs
          fi
          
          # Install dependencies on EC2 (if needed for production builds)
          echo "ğŸ“¦ Installing production dependencies on EC2..."
          services=("user-service" "post-service" "comment-service" "chat-service" "media-service" "notification-service" "analytics-service" "search-service")
          
          for service in "${services[@]}"; do
            if [ -f "./services/$service/package.json" ]; then
              echo "Installing $service dependencies..."
              cd "./services/$service"
              npm ci --only=production || npm install --production
              cd "../.."
            fi
          done
          
          # Docker operations
          echo "ğŸ›‘ Stopping existing services..."
          sudo docker-compose down || true
          
          echo "ğŸ§¹ Cleaning Docker resources..."
          sudo docker system prune -f
          
          echo "ğŸ”¨ Building and starting all services..."
          sudo docker-compose up --build -d
          
          echo "â° Waiting for services to start..."
          sleep 60
          
          echo "ğŸ“Š Final container status:"
          sudo docker-compose ps
          
        EOF

    - name: Comprehensive Health Check
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ env.APP_DIR }}
          
          echo "ğŸ¥ Running health checks..."
          
          # Health check all services
          declare -A services=(
            ["user-service"]=3001
            ["post-service"]=3002
            ["comment-service"]=3003
            ["chat-service"]=3004
            ["media-service"]=3005
            ["notification-service"]=3006
            ["analytics-service"]=3007
            ["search-service"]=3008
          )
          
          healthy_count=0
          total_count=${#services[@]}
          
          for service in "${!services[@]}"; do
            port=${services[$service]}
            
            # Check container status
            if sudo docker-compose ps $service | grep -q "Up"; then
              # Health endpoint check
              for attempt in {1..5}; do
                if curl -f -s --max-time 5 http://localhost:$port/health > /dev/null 2>&1; then
                  echo "âœ… $service healthy (port $port)"
                  healthy_count=$((healthy_count + 1))
                  break
                elif [ $attempt -eq 5 ]; then
                  echo "âš ï¸  $service unhealthy (port $port)"
                else
                  sleep 10
                fi
              done
            else
              echo "âŒ $service container not running"
            fi
          done
          
          echo "ğŸ¥ Health Summary: $healthy_count/$total_count services healthy"
          
          if [ $healthy_count -gt 4 ]; then
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âš ï¸  Some services may need attention"
          fi
          
        EOF

    - name: Show Service URLs
      if: success()
      run: |
        echo "ğŸŒ Your microservices are live:"
        echo "   ğŸš€ User Service:     http://${{ secrets.EC2_HOST }}:3001/health"
        echo "   ğŸ“ Post Service:     http://${{ secrets.EC2_HOST }}:3002/health"
        echo "   ğŸ’¬ Comment Service:  http://${{ secrets.EC2_HOST }}:3003/health"
        echo "   ğŸ’¬ Chat Service:     http://${{ secrets.EC2_HOST }}:3004/health"
        echo "   ğŸ“ Media Service:    http://${{ secrets.EC2_HOST }}:3005/health"
        echo "   ğŸ”” Notification:     http://${{ secrets.EC2_HOST }}:3006/health"
        echo "   ğŸ“Š Analytics:        http://${{ secrets.EC2_HOST }}:3007/health"
        echo "   ğŸ” Search Service:   http://${{ secrets.EC2_HOST }}:3008/health"

    - name: Cleanup
      if: always()
      run: rm -f ~/.ssh/deploy_key
