name: Deploy Microservices with Docker-Compose

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_DIR: /home/ec2-user/microservices-app

jobs:
  deploy:
    name: Deploy to EC2 using Docker-Compose
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH for EC2
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy with Docker-Compose
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "ğŸš€ Deploying with Docker-Compose..."
          
          # Ensure Docker is running
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Setup deployment directory
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Setup SSH for GitHub repository access
          mkdir -p ~/.ssh
          echo "${{ secrets.REPO_SSH_KEY }}" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key
          
          cat > ~/.ssh/config << 'SSH_CONFIG'
        Host github.com
          HostName github.com
          User git
          IdentityFile ~/.ssh/github_deploy_key
          StrictHostKeyChecking no
        SSH_CONFIG
          chmod 600 ~/.ssh/config
          
          # Clone/update repository
          if [ ! -d ".git" ]; then
            echo "ğŸ“¥ Cloning repository..."
            rm -rf * .[^.]* 2>/dev/null || true
            git clone git@github.com:${{ github.repository }}.git .
          else
            echo "ğŸ”„ Updating repository..."
            git remote set-url origin git@github.com:${{ github.repository }}.git
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            git pull origin main
          fi
          
          # Verify docker-compose.yml exists
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ docker-compose.yml not found!"
            ls -la
            exit 1
          fi
          
          echo "âœ… docker-compose.yml found"
          
          # Install Docker Compose if not present
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ“¦ Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
          fi
          
          # Verify Docker Compose version
          echo "ğŸ”§ Docker Compose version:"
          docker-compose --version
          
          # Remove obsolete version warning
          sed -i '/^version:/d' docker-compose.yml 2>/dev/null || true
          
          # Validate docker-compose.yml
          echo "âœ… Validating docker-compose.yml..."
          docker-compose config >/dev/null
          
          # Stop existing services
          echo "ğŸ›‘ Stopping existing services..."
          docker-compose down --remove-orphans || true
          
          # Clean Docker system
          echo "ğŸ§¹ Cleaning Docker resources..."
          sudo docker system prune -f || true
          
          # Start services with Docker Compose (exactly like your local command)
          echo "ğŸ”¨ Starting services with docker-compose up -d..."
          docker-compose up --build -d
          
          echo "â° Waiting for services to start..."
          sleep 60
          
          # Show container status
          echo "ğŸ“Š Docker Compose container status:"
          docker-compose ps
          
          echo "ğŸ³ All running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
        EOF

    - name: Health Check with Docker-Compose
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ env.APP_DIR }}
          
          echo "ğŸ¥ Docker-Compose Health Check..."
          
          # Show compose services status
          echo "=== Docker-Compose Services ==="
          docker-compose ps
          
          # Define services to check
          declare -A services=(
            ["user-service"]=3001
            ["post-service"]=3002
            ["comment-service"]=3003
            ["chat-service"]=3004
            ["media-service"]=3005
            ["notification-service"]=3006
            ["analytics-service"]=3007
            ["search-service"]=3008
          )
          
          healthy_count=0
          total_count=${#services[@]}
          
          echo "ğŸ” Testing $total_count services..."
          
          for service in "${!services[@]}"; do
            port=${services[$service]}
            
            echo "--- Checking $service ---"
            
            # Check if service is running via docker-compose
            if docker-compose ps $service | grep -q "Up"; then
              echo "âœ… $service is running (docker-compose)"
              
              # Test port connectivity
              if timeout 5 bash -c "echo > /dev/tcp/localhost/$port" 2>/dev/null; then
                echo "âœ… $service responding on port $port"
                
                # Try health endpoint
                if curl -f -s --max-time 5 http://localhost:$port/health >/dev/null 2>&1; then
                  echo "âœ… $service health check passed"
                  healthy_count=$((healthy_count + 1))
                else
                  echo "âš ï¸ $service running but health endpoint failed"
                  healthy_count=$((healthy_count + 1))  # Count as healthy if port responds
                fi
              else
                echo "âš ï¸ $service running but port $port not responding"
                echo "Service logs:"
                docker-compose logs --tail=5 $service
              fi
            else
              echo "âŒ $service not running"
              echo "Service logs:"
              docker-compose logs --tail=10 $service
            fi
          done
          
          echo "============================="
          echo "ğŸ¯ Health Summary: $healthy_count/$total_count services healthy"
          
          if [ $healthy_count -eq $total_count ]; then
            echo "ğŸ‰ All services running with docker-compose!"
          elif [ $healthy_count -gt 0 ]; then
            echo "âš ï¸ Partial success: $healthy_count/$total_count services"
          else
            echo "âŒ No services healthy - check logs:"
            docker-compose logs --tail=20
            exit 1
          fi
          
        EOF

    - name: Display Service URLs
      if: success()
      run: |
        echo "ğŸŒ Your Docker-Compose services are live:"
        echo ""
        echo "   ğŸš€ User Service:         http://${{ secrets.EC2_HOST }}:3001/health"
        echo "   ğŸ“ Post Service:         http://${{ secrets.EC2_HOST }}:3002/health"
        echo "   ğŸ’¬ Comment Service:      http://${{ secrets.EC2_HOST }}:3003/health"
        echo "   ğŸ’¬ Chat Service:         http://${{ secrets.EC2_HOST }}:3004/health"
        echo "   ğŸ“ Media Service:        http://${{ secrets.EC2_HOST }}:3005/health"
        echo "   ğŸ”” Notification Service: http://${{ secrets.EC2_HOST }}:3006/health"
        echo "   ğŸ“Š Analytics Service:    http://${{ secrets.EC2_HOST }}:3007/health"
        echo "   ğŸ” Search Service:       http://${{ secrets.EC2_HOST }}:3008/health"

    - name: Cleanup SSH Keys
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key

    - name: Docker-Compose Troubleshooting
      if: failure()
      run: |
        echo "âŒ Docker-Compose deployment failed!"
        echo ""
        echo "ğŸ”§ Troubleshooting commands:"
        echo "1. SSH: ssh -i your-key.pem ec2-user@${{ secrets.EC2_HOST }}"
        echo "2. Navigate: cd ${{ env.APP_DIR }}"
        echo "3. Check status: docker-compose ps"
        echo "4. View logs: docker-compose logs [service-name]"
        echo "5. Restart: docker-compose down && docker-compose up -d"
        echo "6. Check version: docker-compose --version"
