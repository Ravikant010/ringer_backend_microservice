name: Deploy Microservices (Advanced)

on:
  push:
    branches: [ main ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'

env:
  DEPLOYMENT_PATH: /home/ec2-user/microservices-app

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          list-files: 'csv'
          filters: |
            user-service:
              - 'services/user-service/**'
            post-service:
              - 'services/post-service/**'
            comment-service:
              - 'services/comment-service/**'
            chat-service:
              - 'services/chat-service/**'
            media-service:
              - 'services/media-service/**'
            notification-service:
              - 'services/notification-service/**'
            analytics-service:
              - 'services/analytics-service/**'
            search-service:
              - 'services/search-service/**'

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Create environment file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
        FRONTEND_URL=${{ secrets.FRONTEND_URL }}
        REDIS_URL=redis://redis:6379
        EOF

    - name: Deploy with zero downtime
      run: |
        # Copy environment file
        scp -i ~/.ssh/deploy_key .env.production ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOYMENT_PATH }}/.env
        
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ env.DEPLOYMENT_PATH }}
          
          # Backup current deployment
          if [ -f docker-compose.yml ]; then
            sudo docker-compose config > backup-compose-$(date +%Y%m%d-%H%M%S).yml
          fi
          
          # Update code
          git pull origin main || git clone https://github.com/${{ github.repository }}.git .
          
          # Rolling update approach
          echo "Performing rolling update..."
          
          # Build new images
          sudo docker-compose build
          
          # Update services one by one
          SERVICES="user-service post-service comment-service chat-service media-service notification-service analytics-service search-service"
          
          for SERVICE in $SERVICES; do
            echo "Updating $SERVICE..."
            sudo docker-compose up -d --no-deps $SERVICE
            sleep 5
            
            # Quick health check
            if sudo docker-compose ps $SERVICE | grep -q "Up"; then
              echo "‚úÖ $SERVICE updated successfully"
            else
              echo "‚ùå $SERVICE update failed"
              sudo docker-compose logs $SERVICE
            fi
          done
          
          # Final health check
          sudo docker-compose ps
          
        EOF

    - name: Comprehensive Health Check
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ${{ env.DEPLOYMENT_PATH }}
          
          # Create health check script
          cat > health_check.sh << 'HEALTHCHECK'
          #!/bin/bash
          
          declare -A SERVICES=(
            ["user-service"]=3001
            ["post-service"]=3002
            ["comment-service"]=3003
            ["chat-service"]=3004
            ["media-service"]=3005
            ["notification-service"]=3006
            ["analytics-service"]=3007
            ["search-service"]=3008
          )
          
          FAILED=0
          
          echo "üè• Running comprehensive health checks..."
          
          for service in "${!SERVICES[@]}"; do
            port=${SERVICES[$service]}
            
            # Check if container is running
            if ! sudo docker-compose ps $service | grep -q "Up"; then
              echo "‚ùå $service container is not running"
              FAILED=1
              continue
            fi
            
            # Check HTTP health endpoint
            for i in {1..5}; do
              if curl -f -s --max-time 5 http://localhost:$port/health > /dev/null; then
                echo "‚úÖ $service is healthy (port $port)"
                break
              elif [ $i -eq 5 ]; then
                echo "‚ùå $service health check failed after 5 attempts"
                FAILED=1
              else
                echo "‚è≥ $service not ready, retrying... ($i/5)"
                sleep 3
              fi
            done
          done
          
          if [ $FAILED -eq 0 ]; then
            echo "üéâ All services are healthy!"
          else
            echo "üí• Some services failed health checks"
            exit 1
          fi
          HEALTHCHECK
          
          chmod +x health_check.sh
          ./health_check.sh
          
        EOF

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
        rm -f .env.production

    - name: Success notification
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "Changed services: ${{ needs.detect-changes.outputs.services }}"
